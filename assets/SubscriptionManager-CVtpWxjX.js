import{j as e,B as d,b as $,c as J,M as h,F as r}from"./bootstrap-vendor-BaqZ8axc.js";import{r as o}from"./react-vendor-BxsFYPlk.js";import{u as K,s as u}from"./index-Cbh9HDaJ.js";import{C as O}from"./ConfigViewer-CfHTyAUI.js";import"./axios-vendor-B9ygI19o.js";function ae(){var k;const{showToast:l}=K(),[C,F]=o.useState([]),[z,p]=o.useState(!1),[B,v]=o.useState(!1),[D,T]=o.useState(""),[H,q]=o.useState(""),[P,S]=o.useState(!1),[f,g]=o.useState(null),[A,m]=o.useState(!1),[w,_]=o.useState(""),[j,G]=o.useState(null),[E,N]=o.useState(!1),[y,M]=o.useState(!1),[a,c]=o.useState({name:"",type:"remote",url:"",config_content:"",update_interval:1440}),[L,b]=o.useState({}),x=async()=>{try{const t=await u.getAll();F(t.data)}catch(t){console.error("Failed to load subscriptions:",t)}};o.useEffect(()=>{x()},[]);const I=async t=>{var n,i;t.preventDefault();try{const s={name:a.name,type:a.type,update_interval:a.type==="local"?0:a.update_interval};a.type==="remote"?s.url=a.url:(s.config_content=a.config_content,s.url=null),f?(await u.update(f.id,s),l("订阅更新成功","success")):(await u.create(s),l("订阅创建成功","success")),p(!1),g(null),c({name:"",type:"remote",url:"",config_content:"",update_interval:1440}),x()}catch(s){l(((i=(n=s.response)==null?void 0:n.data)==null?void 0:i.detail)||"操作失败","error")}},U=async t=>{if(g(t),p(!0),t.type==="local")try{const n=await u.getConfig(t.id);c({name:t.name,type:t.type,url:t.url||"",config_content:n.data.config,update_interval:t.update_interval})}catch{c({name:t.name,type:t.type,url:t.url||"",config_content:"",update_interval:t.update_interval})}else c({name:t.name,type:t.type,url:t.url||"",config_content:"",update_interval:t.update_interval})},Y=async t=>{if(confirm("确定要删除此订阅吗？"))try{await u.delete(t),l("订阅删除成功","success"),x()}catch{l("删除失败","error")}},R=async t=>{b(n=>({...n,[t]:!0}));try{await u.updateContent(t),l("更新成功","success"),x()}catch{l("更新失败","error")}finally{b(n=>{const i={...n};return delete i[t],i})}},V=async t=>{var n,i;S(!0),q(`订阅配置 - ${t.name}`);try{const s=await u.getConfig(t.id);T(s.data.config),v(!0)}catch(s){l(((i=(n=s.response)==null?void 0:n.data)==null?void 0:i.detail)||"获取配置失败","error")}finally{S(!1)}},W=async t=>{var n,i;G(t.id),N(!0);try{const s=await u.getExtendConfig(t.id);_(s.data.content||""),m(!0)}catch(s){l(((i=(n=s.response)==null?void 0:n.data)==null?void 0:i.detail)||"获取扩展配置失败","error")}finally{N(!1)}},X=async()=>{var t,n;if(j!==null){M(!0);try{await u.saveExtendConfig(j,w),m(!1),l("扩展配置保存成功","success"),x()}catch(i){l(((n=(t=i.response)==null?void 0:t.data)==null?void 0:n.detail)||"保存扩展配置失败","error")}finally{M(!1)}}};return e.jsxs("div",{children:[e.jsxs("div",{className:"d-flex justify-content-between mb-3",children:[e.jsx("h4",{children:"订阅管理"}),e.jsx(d,{onClick:()=>{g(null),c({name:"",type:"remote",url:"",config_content:"",update_interval:1440}),p(!0)},children:"添加订阅"})]}),e.jsxs($,{striped:!0,bordered:!0,hover:!0,className:"modern-table align-middle",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID"}),e.jsx("th",{children:"名称"}),e.jsx("th",{children:"URL"}),e.jsx("th",{children:"更新间隔（分钟）"}),e.jsx("th",{children:"最后更新"}),e.jsx("th",{children:"操作"})]})}),e.jsx("tbody",{children:C.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:t.id}),e.jsx("td",{children:t.name}),e.jsx("td",{children:t.type==="local"?e.jsx(J,{bg:"info",children:"本地配置"}):e.jsx("small",{children:t.url?t.url.substring(0,50)+"...":"-"})}),e.jsx("td",{children:t.update_interval}),e.jsx("td",{children:t.last_update?new Date(t.last_update).toLocaleString():"从未更新"}),e.jsxs("td",{children:[e.jsx(d,{size:"sm",variant:"info",onClick:()=>V(t),className:"me-2",children:"查看配置"}),e.jsx(d,{size:"sm",variant:"warning",onClick:()=>W(t),className:"me-2",children:"扩展配置"}),e.jsx(d,{size:"sm",variant:"primary",onClick:()=>U(t),className:"me-2",children:"编辑"}),t.type==="remote"&&e.jsx(d,{size:"sm",variant:"success",onClick:()=>R(t.id),className:"me-2",disabled:L[t.id],children:L[t.id]?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"}),"更新中..."]}):"更新"}),e.jsx(d,{size:"sm",variant:"danger",onClick:()=>Y(t.id),children:"删除"})]})]},t.id))})]}),e.jsxs(h,{show:z,onHide:()=>p(!1),children:[e.jsx(h.Header,{closeButton:!0,children:e.jsx(h.Title,{children:f?"编辑订阅":"添加订阅"})}),e.jsxs(r,{onSubmit:I,children:[e.jsxs(h.Body,{children:[e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"名称"}),e.jsx(r.Control,{type:"text",value:a.name,onChange:t=>c({...a,name:t.target.value}),required:!0})]}),e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"类型"}),e.jsxs(r.Select,{value:a.type,onChange:t=>c({...a,type:t.target.value}),required:!0,children:[e.jsx("option",{value:"remote",children:"远程连接"}),e.jsx("option",{value:"local",children:"本地配置"})]})]}),a.type==="remote"?e.jsxs(e.Fragment,{children:[e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"订阅链接"}),e.jsx(r.Control,{type:"url",value:a.url,onChange:t=>c({...a,url:t.target.value}),required:!0,placeholder:"https://example.com/subscription.yaml"})]}),e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"更新间隔（分钟）"}),e.jsx(r.Control,{type:"number",value:a.update_interval,onChange:t=>c({...a,update_interval:parseInt(t.target.value)}),required:!0,min:"0"})]})]}):e.jsxs(r.Group,{className:"mb-3",children:[e.jsx(r.Label,{children:"YAML 配置"}),e.jsx(r.Control,{as:"textarea",rows:15,value:a.config_content,onChange:t=>c({...a,config_content:t.target.value}),required:!0,placeholder:"粘贴 YAML 配置内容...",style:{fontFamily:'Consolas, Monaco, "Courier New", monospace',fontSize:"13px"}})]})]}),e.jsxs(h.Footer,{children:[e.jsx(d,{variant:"secondary",onClick:()=>p(!1),children:"取消"}),e.jsx(d,{variant:"primary",type:"submit",children:"保存"})]})]})]}),e.jsx(O,{show:B,onHide:()=>v(!1),title:H,config:D,format:"yaml"}),e.jsxs(h,{show:A,onHide:()=>m(!1),size:"lg",fullscreen:"lg-down",children:[e.jsx(h.Header,{closeButton:!0,children:e.jsxs(h.Title,{children:["扩展配置 - ",((k=C.find(t=>t.id===j))==null?void 0:k.name)||""]})}),e.jsx(h.Body,{style:{padding:0},children:E?e.jsx("div",{className:"p-5 text-center",children:e.jsx("div",{className:"spinner-border",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"加载中..."})})}):e.jsx("textarea",{value:w,onChange:t=>_(t.target.value),style:{width:"100%",height:"70vh",padding:"15px",fontFamily:'Consolas, Monaco, "Courier New", monospace',fontSize:"13px",lineHeight:"1.5",border:"none",outline:"none",backgroundColor:"#1e1e1e",color:"#d4d4d4",resize:"none",whiteSpace:"pre",overflowWrap:"normal",overflowX:"auto"},spellCheck:!1,placeholder:"输入YAML格式的扩展配置..."})}),e.jsxs(h.Footer,{children:[e.jsx(d,{variant:"secondary",onClick:()=>m(!1),disabled:y,children:"取消"}),e.jsx(d,{variant:"primary",onClick:X,disabled:E||y,children:y?"保存中...":"保存"})]})]})]})}export{ae as default};
