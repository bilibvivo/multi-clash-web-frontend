import{j as s,C as b,F as C}from"./bootstrap-vendor-BaqZ8axc.js";import{r}from"./react-vendor-BxsFYPlk.js";import{u as k}from"./useWebSocket-Ct4q0eJe.js";import{i as E}from"./index-05INDnVH.js";import{R as X,A as I,C as Y,X as H,Y as q,T as J,L as Q,a as B}from"./chart-vendor-BOne-368.js";import"./axios-vendor-B9ygI19o.js";const R={"10m":10*60*1e3,"1h":60*60*1e3,"1d":24*60*60*1e3},D={"10m":"最近 10 分钟","1h":"最近 1 小时","1d":"最近 1 天"},V=R["1d"],Z=({active:N,payload:i,label:v,formatSpeed:c})=>N&&i&&i.length?s.jsxs("div",{className:"p-2 rounded bg-dark text-light border border-secondary",children:[s.jsx("div",{className:"small text-muted",children:v}),i.map((m,p)=>s.jsxs("div",{children:[m.name,": ",c(m.value)]},p))]}):null;function ns({instances:N,selectedInstanceId:i,onInstanceChange:v}){const[c,m]=r.useState(null),[p,_]=r.useState({upload:0,download:0}),[f,G]=r.useState({uploadTotal:0,downloadTotal:0,memory:0,connections:0}),[T,O]=r.useState([]),[j,L]=r.useState("10m"),[d,M]=r.useState(null),[g,W]=r.useState({});r.useEffect(()=>{(async()=>{if(!i){m(null),M(null);return}try{const[e,o]=await Promise.all([E.getById(i),E.getWsInfo(i)]);m(e.data),M(o.data)}catch(e){console.error("Failed to load instance:",e)}})()},[i]);const F=d&&c&&c.status==="running"?d.traffic_url:null,K=d&&c&&c.status==="running"?d.connections_url??null:null,{lastMessage:n,isConnected:P}=k(F),{lastMessage:l}=k(K);r.useEffect(()=>{if(n)try{let t=0,e=0;const o=Date.now();if(typeof n=="object"&&n!==null){const a=Number(n.up??n.upload)||0,w=Number(n.down??n.download)||0;if(t=a,e=w,t===0&&e===0&&("uploadTotal"in n||"downloadTotal"in n)){const u=Number(n.uploadTotal)||0,x=Number(n.downloadTotal)||0,y=g.timestamp?Math.max(1,o-g.timestamp)/1e3:0;y>0&&(t=u>0?(u-(g.uploadTotal||0))/y:0,e=x>0?(x-(g.downloadTotal||0))/y:0),W({uploadTotal:u,downloadTotal:x,timestamp:o})}}_({upload:t,download:e}),O(a=>{const w=[...a,{timestamp:o,upload:t,download:e}],u=o-V;return w.filter(x=>x.timestamp>=u)})}catch(t){console.error("Error processing traffic message:",t,n)}},[n]),r.useEffect(()=>{if(l)try{if(typeof l=="object"&&l!==null){const t=Number(l.downloadTotal)||0,e=Number(l.uploadTotal)||0,o=Number(l.memory)||0,a=Array.isArray(l.connections)?l.connections.length:Number(l.connections)||0;G({downloadTotal:t,uploadTotal:e,memory:o,connections:a})}}catch(t){console.error("Error processing connections message:",t,l)}},[l]);const h=t=>{if(t===0)return"0 B";const e=1024,o=["B","KB","MB","GB"],a=Math.floor(Math.log(t)/Math.log(e));return Math.round(t/Math.pow(e,a)*100)/100+" "+o[a]},S=t=>{if(t===0)return"0 B/s";const e=1024,o=["B/s","KB/s","MB/s","GB/s"],a=Math.min(Math.floor(Math.log(t)/Math.log(e)),o.length-1);return Math.round(t/Math.pow(e,a)*100)/100+" "+o[a]},z=(t,e)=>{const o=new Date(t);if(e==="1d")return o.toLocaleString([],{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1});const a=e==="10m";return o.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:a?"2-digit":void 0,hour12:!1})},A=R[j],U=r.useMemo(()=>{const e=Date.now()-A;return T.filter(a=>a.timestamp>=e).map(a=>({time:z(a.timestamp,j),upload:a.upload,download:a.download}))},[T,A,j]);return s.jsxs(b,{children:[s.jsx(b.Header,{children:s.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[s.jsxs("div",{className:"d-flex align-items-center gap-2",children:[s.jsx("h5",{className:"mb-0",children:"流量监控"}),c&&c.status==="running"&&(P?s.jsx("span",{className:"badge bg-success",children:"已连接"}):s.jsx("span",{className:"badge bg-danger",children:"未连接"}))]}),s.jsxs("div",{className:"d-flex gap-2",children:[s.jsxs(C.Select,{value:i||"",onChange:t=>v(t.target.value?parseInt(t.target.value):null),style:{width:"auto"},children:[s.jsx("option",{value:"",children:"选择实例"}),N.filter(t=>t.status==="running").map(t=>s.jsxs("option",{value:t.id,children:[t.name," (端口: ",t.port,")"]},t.id))]}),s.jsx(C.Select,{value:j,onChange:t=>L(t.target.value),style:{width:"auto"},children:Object.keys(D).map(t=>s.jsx("option",{value:t,children:D[t]},t))})]})]})}),s.jsx(b.Body,{children:i?c?c.status!=="running"?s.jsx("div",{className:"alert alert-warning",children:"实例未运行，无法获取实时数据"}):s.jsxs(s.Fragment,{children:[d&&s.jsx("div",{className:"mb-3",children:s.jsxs("small",{className:"text-muted",children:["WebSocket: ",d.traffic_url,!d.secret&&s.jsx("span",{className:"text-warning ms-2",children:"(无 token)"})]})}),s.jsxs("div",{className:"row mb-3 g-3",children:[s.jsx("div",{className:"col-lg-2 col-md-6",children:s.jsx("div",{className:"card",children:s.jsxs("div",{className:"card-body",children:[s.jsx("h5",{className:"card-title",children:"上传带宽"}),s.jsx("h3",{children:h(p.upload)})]})})}),s.jsx("div",{className:"col-lg-2 col-md-6",children:s.jsx("div",{className:"card",children:s.jsxs("div",{className:"card-body",children:[s.jsx("h5",{className:"card-title",children:"下载带宽"}),s.jsx("h3",{children:h(p.download)})]})})}),s.jsx("div",{className:"col-lg-2 col-md-6",children:s.jsx("div",{className:"card",children:s.jsxs("div",{className:"card-body",children:[s.jsx("h5",{className:"card-title",children:"总下载流量"}),s.jsx("h3",{children:h(f.downloadTotal)})]})})}),s.jsx("div",{className:"col-lg-2 col-md-6",children:s.jsx("div",{className:"card",children:s.jsxs("div",{className:"card-body",children:[s.jsx("h5",{className:"card-title",children:"总上传流量"}),s.jsx("h3",{children:h(f.uploadTotal)})]})})}),s.jsx("div",{className:"col-lg-2 col-md-6",children:s.jsx("div",{className:"card",children:s.jsxs("div",{className:"card-body",children:[s.jsx("h5",{className:"card-title",children:"占用内存"}),s.jsx("h3",{children:h(f.memory)})]})})}),s.jsx("div",{className:"col-lg-2 col-md-6",children:s.jsx("div",{className:"card",children:s.jsxs("div",{className:"card-body",children:[s.jsx("h5",{className:"card-title",children:"连接数"}),s.jsx("h3",{children:f.connections})]})})})]}),s.jsx("div",{style:{height:260},children:s.jsx(X,{width:"100%",height:"100%",children:s.jsxs(I,{data:U,margin:{top:10,right:16,bottom:8,left:0},children:[s.jsxs("defs",{children:[s.jsxs("linearGradient",{id:"colorDownload",x1:"0",y1:"0",x2:"0",y2:"1",children:[s.jsx("stop",{offset:"5%",stopColor:"#5ba5f7",stopOpacity:.4}),s.jsx("stop",{offset:"95%",stopColor:"#5ba5f7",stopOpacity:.05})]}),s.jsxs("linearGradient",{id:"colorUpload",x1:"0",y1:"0",x2:"0",y2:"1",children:[s.jsx("stop",{offset:"5%",stopColor:"#f57c8a",stopOpacity:.25}),s.jsx("stop",{offset:"95%",stopColor:"#f57c8a",stopOpacity:.02})]})]}),s.jsx(Y,{stroke:"rgba(0,0,0,0.08)",strokeDasharray:"4 4"}),s.jsx(H,{dataKey:"time",tick:{fill:"#888",fontSize:10},interval:"preserveStartEnd",minTickGap:24}),s.jsx(q,{tickFormatter:t=>S(Number(t)),tick:{fill:"#666",fontSize:10},width:80}),s.jsx(J,{content:s.jsx(Z,{formatSpeed:S})}),s.jsx(Q,{verticalAlign:"top",height:32}),s.jsx(B,{type:"monotone",dataKey:"download",name:"下载",stroke:"#5ba5f7",fill:"url(#colorDownload)",strokeWidth:2,fillOpacity:1,isAnimationActive:!1}),s.jsx(B,{type:"monotone",dataKey:"upload",name:"上传",stroke:"#f57c8a",fill:"url(#colorUpload)",strokeWidth:1.5,fillOpacity:1,isAnimationActive:!1})]})})})]}):s.jsx("div",{className:"text-center text-muted p-5",children:"正在加载实例信息..."}):s.jsx("div",{className:"text-center text-muted p-5",children:"请选择一个运行中的实例"})})]})}export{ns as default};
