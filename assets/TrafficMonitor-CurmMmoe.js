import{j as s,C as b,F as B}from"./bootstrap-vendor-BaqZ8axc.js";import{r}from"./react-vendor-BxsFYPlk.js";import{u as C}from"./useWebSocket-Ct4q0eJe.js";import{i as E,g as I}from"./index-B0uoZxv7.js";import{R as Y,A as $,C as H,X as q,Y as J,T as Q,L as V,a as R}from"./chart-vendor-BOne-368.js";import"./axios-vendor-B9ygI19o.js";const U={"10m":10*60*1e3,"1h":60*60*1e3,"1d":24*60*60*1e3},D={"10m":"最近 10 分钟","1h":"最近 1 小时","1d":"最近 1 天"},Z=U["1d"],ss=({active:N,payload:c,label:v,formatSpeed:i})=>N&&c&&c.length?s.jsxs("div",{className:"p-2 rounded bg-dark text-light border border-secondary",children:[s.jsx("div",{className:"small text-muted",children:v}),c.map((m,p)=>s.jsxs("div",{children:[m.name,": ",i(m.value)]},p))]}):null;function rs({instances:N,selectedInstanceId:c,onInstanceChange:v}){const[i,m]=r.useState(null),[p,_]=r.useState({upload:0,download:0}),[f,G]=r.useState({uploadTotal:0,downloadTotal:0,memory:0,connections:0}),[T,L]=r.useState([]),[j,O]=r.useState("10m"),[d,S]=r.useState(null),[g,W]=r.useState({});r.useEffect(()=>{(async()=>{if(!c){m(null),S(null);return}try{const[t,a]=await Promise.all([E.getById(c),E.getWsInfo(c)]);m(t.data),S(a.data)}catch(t){console.error("Failed to load instance:",t)}})()},[c]);const M=e=>{if(!e)return null;const t=I();try{const a=new URL(t);return e.replace(/ws:\/\/127\.0\.0\.1:/g,`ws://${a.hostname}:`).replace(/ws:\/\/localhost:/g,`ws://${a.hostname}:`)}catch{return e}},z=d&&i&&i.status==="running"?M(d.traffic_url):null,F=d&&i&&i.status==="running"?M(d.connections_url??null):null,{lastMessage:n,isConnected:K}=C(z),{lastMessage:l}=C(F);r.useEffect(()=>{if(n)try{let e=0,t=0;const a=Date.now();if(typeof n=="object"&&n!==null){const o=Number(n.up??n.upload)||0,w=Number(n.down??n.download)||0;if(e=o,t=w,e===0&&t===0&&("uploadTotal"in n||"downloadTotal"in n)){const u=Number(n.uploadTotal)||0,x=Number(n.downloadTotal)||0,y=g.timestamp?Math.max(1,a-g.timestamp)/1e3:0;y>0&&(e=u>0?(u-(g.uploadTotal||0))/y:0,t=x>0?(x-(g.downloadTotal||0))/y:0),W({uploadTotal:u,downloadTotal:x,timestamp:a})}}_({upload:e,download:t}),L(o=>{const w=[...o,{timestamp:a,upload:e,download:t}],u=a-Z;return w.filter(x=>x.timestamp>=u)})}catch(e){console.error("Error processing traffic message:",e,n)}},[n]),r.useEffect(()=>{if(l)try{if(typeof l=="object"&&l!==null){const e=Number(l.downloadTotal)||0,t=Number(l.uploadTotal)||0,a=Number(l.memory)||0,o=Array.isArray(l.connections)?l.connections.length:Number(l.connections)||0;G({downloadTotal:e,uploadTotal:t,memory:a,connections:o})}}catch(e){console.error("Error processing connections message:",e,l)}},[l]);const h=e=>{if(e===0)return"0 B";const t=1024,a=["B","KB","MB","GB"],o=Math.floor(Math.log(e)/Math.log(t));return Math.round(e/Math.pow(t,o)*100)/100+" "+a[o]},A=e=>{if(e===0)return"0 B/s";const t=1024,a=["B/s","KB/s","MB/s","GB/s"],o=Math.min(Math.floor(Math.log(e)/Math.log(t)),a.length-1);return Math.round(e/Math.pow(t,o)*100)/100+" "+a[o]},P=(e,t)=>{const a=new Date(e);if(t==="1d")return a.toLocaleString([],{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1});const o=t==="10m";return a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:o?"2-digit":void 0,hour12:!1})},k=U[j],X=r.useMemo(()=>{const t=Date.now()-k;return T.filter(o=>o.timestamp>=t).map(o=>({time:P(o.timestamp,j),upload:o.upload,download:o.download}))},[T,k,j]);return s.jsxs(b,{children:[s.jsx(b.Header,{children:s.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[s.jsxs("div",{className:"d-flex align-items-center gap-2",children:[s.jsx("h5",{className:"mb-0",children:"流量监控"}),i&&i.status==="running"&&(K?s.jsx("span",{className:"badge bg-success",children:"已连接"}):s.jsx("span",{className:"badge bg-danger",children:"未连接"}))]}),s.jsxs("div",{className:"d-flex gap-2",children:[s.jsxs(B.Select,{value:c||"",onChange:e=>v(e.target.value?parseInt(e.target.value):null),style:{width:"auto"},children:[s.jsx("option",{value:"",children:"选择实例"}),N.filter(e=>e.status==="running").map(e=>s.jsxs("option",{value:e.id,children:[e.name," (端口: ",e.port,")"]},e.id))]}),s.jsx(B.Select,{value:j,onChange:e=>O(e.target.value),style:{width:"auto"},children:Object.keys(D).map(e=>s.jsx("option",{value:e,children:D[e]},e))})]})]})}),s.jsx(b.Body,{children:c?i?i.status!=="running"?s.jsx("div",{className:"alert alert-warning",children:"实例未运行，无法获取实时数据"}):s.jsxs(s.Fragment,{children:[d&&s.jsx("div",{className:"mb-3",children:s.jsxs("small",{className:"text-muted",children:["WebSocket: ",d.traffic_url,!d.secret&&s.jsx("span",{className:"text-warning ms-2",children:"(无 token)"})]})}),s.jsxs("div",{className:"row mb-3 g-3",children:[s.jsx("div",{className:"col-lg-2 col-md-6",children:s.jsx("div",{className:"card",children:s.jsxs("div",{className:"card-body",children:[s.jsx("h5",{className:"card-title",children:"上传带宽"}),s.jsx("h3",{children:h(p.upload)})]})})}),s.jsx("div",{className:"col-lg-2 col-md-6",children:s.jsx("div",{className:"card",children:s.jsxs("div",{className:"card-body",children:[s.jsx("h5",{className:"card-title",children:"下载带宽"}),s.jsx("h3",{children:h(p.download)})]})})}),s.jsx("div",{className:"col-lg-2 col-md-6",children:s.jsx("div",{className:"card",children:s.jsxs("div",{className:"card-body",children:[s.jsx("h5",{className:"card-title",children:"总下载流量"}),s.jsx("h3",{children:h(f.downloadTotal)})]})})}),s.jsx("div",{className:"col-lg-2 col-md-6",children:s.jsx("div",{className:"card",children:s.jsxs("div",{className:"card-body",children:[s.jsx("h5",{className:"card-title",children:"总上传流量"}),s.jsx("h3",{children:h(f.uploadTotal)})]})})}),s.jsx("div",{className:"col-lg-2 col-md-6",children:s.jsx("div",{className:"card",children:s.jsxs("div",{className:"card-body",children:[s.jsx("h5",{className:"card-title",children:"占用内存"}),s.jsx("h3",{children:h(f.memory)})]})})}),s.jsx("div",{className:"col-lg-2 col-md-6",children:s.jsx("div",{className:"card",children:s.jsxs("div",{className:"card-body",children:[s.jsx("h5",{className:"card-title",children:"连接数"}),s.jsx("h3",{children:f.connections})]})})})]}),s.jsx("div",{style:{height:260},children:s.jsx(Y,{width:"100%",height:"100%",children:s.jsxs($,{data:X,margin:{top:10,right:16,bottom:8,left:0},children:[s.jsxs("defs",{children:[s.jsxs("linearGradient",{id:"colorDownload",x1:"0",y1:"0",x2:"0",y2:"1",children:[s.jsx("stop",{offset:"5%",stopColor:"#5ba5f7",stopOpacity:.4}),s.jsx("stop",{offset:"95%",stopColor:"#5ba5f7",stopOpacity:.05})]}),s.jsxs("linearGradient",{id:"colorUpload",x1:"0",y1:"0",x2:"0",y2:"1",children:[s.jsx("stop",{offset:"5%",stopColor:"#f57c8a",stopOpacity:.25}),s.jsx("stop",{offset:"95%",stopColor:"#f57c8a",stopOpacity:.02})]})]}),s.jsx(H,{stroke:"rgba(0,0,0,0.08)",strokeDasharray:"4 4"}),s.jsx(q,{dataKey:"time",tick:{fill:"#888",fontSize:10},interval:"preserveStartEnd",minTickGap:24}),s.jsx(J,{tickFormatter:e=>A(Number(e)),tick:{fill:"#666",fontSize:10},width:80}),s.jsx(Q,{content:s.jsx(ss,{formatSpeed:A})}),s.jsx(V,{verticalAlign:"top",height:32}),s.jsx(R,{type:"monotone",dataKey:"download",name:"下载",stroke:"#5ba5f7",fill:"url(#colorDownload)",strokeWidth:2,fillOpacity:1,isAnimationActive:!1}),s.jsx(R,{type:"monotone",dataKey:"upload",name:"上传",stroke:"#f57c8a",fill:"url(#colorUpload)",strokeWidth:1.5,fillOpacity:1,isAnimationActive:!1})]})})})]}):s.jsx("div",{className:"text-center text-muted p-5",children:"正在加载实例信息..."}):s.jsx("div",{className:"text-center text-muted p-5",children:"请选择一个运行中的实例"})})]})}export{rs as default};
