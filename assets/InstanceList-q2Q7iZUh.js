import{j as e,b as U,F as b,B as g,c as q}from"./bootstrap-vendor-BaqZ8axc.js";import{r as n}from"./react-vendor-BxsFYPlk.js";import{u as G,i as c}from"./index-Cbh9HDaJ.js";import{C as J}from"./ConfigViewer-CfHTyAUI.js";import"./axios-vendor-B9ygI19o.js";function Z({onRefresh:d}){const{showToast:l}=G(),[S,f]=n.useState([]),[k,v]=n.useState(!0),[N,x]=n.useState(!1),[F,I]=n.useState(""),[T,_]=n.useState(""),[z,P]=n.useState(""),[A,h]=n.useState(!1),[m,u]=n.useState({}),o=async()=>{try{const t=await c.getAll();f(t.data)}catch(t){console.error("Failed to load instances:",t)}finally{v(!1)}};n.useEffect(()=>{o();const t=setInterval(o,5e3);return()=>clearInterval(t)},[]);const L=async t=>{var r,i;u(s=>({...s,[t]:{...s[t],start:!0}}));try{await c.start(t),l("实例启动成功","success"),o(),d==null||d()}catch(s){l(((i=(r=s.response)==null?void 0:r.data)==null?void 0:i.detail)||"启动失败","error")}finally{u(s=>{const a={...s};return a[t]&&(delete a[t].start,Object.keys(a[t]).length===0&&delete a[t]),a})}},B=async t=>{var r,i;u(s=>({...s,[t]:{...s[t],stop:!0}}));try{await c.stop(t),l("实例停止成功","success"),o(),d==null||d()}catch(s){l(((i=(r=s.response)==null?void 0:r.data)==null?void 0:i.detail)||"停止失败","error")}finally{u(s=>{const a={...s};return a[t]&&(delete a[t].stop,Object.keys(a[t]).length===0&&delete a[t]),a})}},O=async t=>{var r,i;u(s=>({...s,[t]:{...s[t],restart:!0}}));try{await c.restart(t),l("实例重启成功","success"),o(),d==null||d()}catch(s){l(((i=(r=s.response)==null?void 0:r.data)==null?void 0:i.detail)||"重启失败","error")}finally{u(s=>{const a={...s};return a[t]&&(delete a[t].restart,Object.keys(a[t]).length===0&&delete a[t]),a})}},$=async t=>{if(confirm("确定要删除此实例吗？"))try{await c.delete(t),l("实例删除成功","success"),o(),d==null||d()}catch{l("删除失败","error")}},D=async t=>{var r,i;h(!0),_(`运行时配置 - ${t.name}`);try{const s=await c.getConfig(t.id);I(s.data.config),P(s.data.config_path||""),x(!0)}catch(s){l(((i=(r=s.response)==null?void 0:r.data)==null?void 0:i.detail)||"获取配置失败","error")}finally{h(!1)}},E=async t=>{var r,i;if(confirm(`确定要更新实例 "${t.name}" 的配置吗？这将重新合并配置并应用扩展配置。`))try{await c.updateConfig(t.id),l("配置更新成功","success"),o(),d==null||d()}catch(s){l(((i=(r=s.response)==null?void 0:r.data)==null?void 0:i.detail)||"更新配置失败","error")}},M=async(t,r)=>{var i,s;try{r?(await c.setSystemProxy(t.id),l("系统代理设置成功","success")):(await c.unsetSystemProxy(t.id),l("系统代理已取消","success")),o(),d==null||d()}catch(a){l(((s=(i=a.response)==null?void 0:i.data)==null?void 0:s.detail)||"操作失败","error"),o()}},V=async(t,r)=>{var i,s;try{await c.setAutoStart(t.id,r),l(r?"已启用自动启动":"已禁用自动启动","success"),o(),d==null||d()}catch(a){l(((s=(i=a.response)==null?void 0:i.data)==null?void 0:s.detail)||"操作失败","error"),o()}},H=t=>{const r={running:"success",stopped:"secondary",error:"danger"};return e.jsx(q,{bg:r[t]||"secondary",children:t})};return k?e.jsx("div",{children:"加载中..."}):e.jsxs("div",{children:[e.jsxs(U,{striped:!0,bordered:!0,hover:!0,className:"modern-table align-middle",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID"}),e.jsx("th",{children:"名称"}),e.jsx("th",{children:"控制端口"}),e.jsx("th",{children:"混合端口"}),e.jsx("th",{children:"进程PID"}),e.jsx("th",{children:"状态"}),e.jsx("th",{children:"自动启动"}),e.jsx("th",{children:"操作"})]})}),e.jsx("tbody",{children:S.map(t=>{var r,i,s,a,y,j,C,w;return e.jsxs("tr",{children:[e.jsx("td",{children:t.id}),e.jsx("td",{children:t.name}),e.jsx("td",{children:t.port}),e.jsx("td",{children:t.mixed_port||"-"}),e.jsx("td",{children:t.pid||"-"}),e.jsx("td",{children:H(t.status)}),e.jsx("td",{children:e.jsx(b.Check,{type:"switch",id:`auto-start-${t.id}`,checked:t.auto_start===1,onChange:p=>V(t,p.target.checked),style:{cursor:"pointer"}})}),e.jsxs("td",{children:[t.status==="running"&&(t.mixed_port||t.http_port)&&e.jsx(b.Check,{type:"switch",id:`system-proxy-${t.id}`,label:"系统代理",checked:t.is_system_proxy===1,onChange:p=>M(t,p.target.checked),className:"d-inline-block me-2",style:{verticalAlign:"middle"}}),e.jsx(g,{size:"sm",variant:"secondary",onClick:()=>D(t),className:"me-2",disabled:A,children:"查看配置"}),e.jsx(g,{size:"sm",variant:"primary",onClick:()=>E(t),className:"me-2",children:"更新配置"}),t.status==="running"?e.jsxs(e.Fragment,{children:[e.jsx(g,{size:"sm",variant:"warning",onClick:()=>B(t.id),className:"me-2",disabled:((r=m[t.id])==null?void 0:r.stop)||((i=m[t.id])==null?void 0:i.restart),children:(s=m[t.id])!=null&&s.stop?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"}),"停止中..."]}):"停止"}),e.jsx(g,{size:"sm",variant:"info",onClick:()=>O(t.id),className:"me-2",disabled:((a=m[t.id])==null?void 0:a.stop)||((y=m[t.id])==null?void 0:y.restart),children:(j=m[t.id])!=null&&j.restart?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"}),"重启中..."]}):"重启"})]}):e.jsx(g,{size:"sm",variant:"success",onClick:()=>L(t.id),className:"me-2",disabled:(C=m[t.id])==null?void 0:C.start,children:(w=m[t.id])!=null&&w.start?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"}),"启动中..."]}):"启动"}),e.jsx(g,{size:"sm",variant:"danger",onClick:()=>$(t.id),children:"删除"})]})]},t.id)})})]}),e.jsx(J,{show:N,onHide:()=>x(!1),title:T,config:F,format:"yaml",configPath:z})]})}export{Z as default};
